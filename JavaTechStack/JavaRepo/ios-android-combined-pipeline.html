<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bitbucket CI/CD ‚Äì iOS + Android (Windows Devs)</title>

  <style>
    body {
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 32px;
      line-height: 1.65;
    }

    h1, h2, h3 {
      color: #38bdf8;
    }

    h1 {
      font-size: 30px;
      margin-bottom: 12px;
    }

    h2 {
      font-size: 22px;
      margin-top: 44px;
      border-bottom: 1px solid #1e293b;
      padding-bottom: 6px;
    }

    h3 {
      font-size: 18px;
      margin-top: 26px;
    }

    p {
      color: #cbd5f5;
    }

    ul, ol {
      margin-left: 22px;
    }

    li {
      margin-bottom: 8px;
    }

    code {
      color: #22d3ee;
    }

    pre {
      margin: 0;
      font-family: Consolas, "Courier New", monospace;
      font-size: 14px;
      color: #e5e7eb;
    }

    .code-box {
      background: #020617;
      border-radius: 12px;
      padding: 18px;
      margin-top: 18px;
      overflow-x: auto;
      border: 1px solid #1e293b;
    }

    .note {
      background: #020617;
      border-left: 4px solid #ef4444;
      padding: 14px 18px;
      margin-top: 22px;
      border-radius: 6px;
      color: #fca5a5;
    }

    .good {
      border-left-color: #22c55e;
      color: #bbf7d0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
    }

    th, td {
      border: 1px solid #1e293b;
      padding: 10px 12px;
      text-align: left;
    }

    th {
      background: #020617;
      color: #38bdf8;
    }

    td {
      color: #cbd5f5;
    }

    footer {
      margin-top: 70px;
      font-size: 13px;
      color: #94a3b8;
      text-align: center;
    }
  </style>
</head>

<body>

<h1>üöÄ Bitbucket CI/CD ‚Äì iOS + Android (Windows Developers)</h1>

<p>
This document describes a <strong>real-world, production-ready Bitbucket pipeline</strong>
for building and deploying <strong>Android and iOS apps</strong>, while developers work
entirely on <strong>Windows</strong>.
</p>

<h2>üî¥ Reality Check ‚Äì iOS Builds</h2>

<div class="note">
‚ùå iOS builds <strong>cannot</strong> run on Windows or Linux<br/>
‚úÖ iOS builds <strong>must</strong> run on macOS
</div>

<h2>‚úÖ Supported Execution Model</h2>

<table>
  <tr>
    <th>Platform</th>
    <th>Where It Runs</th>
  </tr>
  <tr>
    <td>Android</td>
    <td>Bitbucket Cloud Linux Runner</td>
  </tr>
  <tr>
    <td>iOS</td>
    <td>Self-Hosted macOS Runner</td>
  </tr>
  <tr>
    <td>Developers</td>
    <td>Windows</td>
  </tr>
</table>

<h2>üß† Final Architecture</h2>

<div class="code-box">
<pre>
Windows Dev Machine
        |
        v
   Push Code to Bitbucket
        |
        ‚îú‚îÄ‚îÄ Android Pipeline (Linux Runner)
        |      ‚îî‚îÄ‚îÄ Gradle ‚Üí AAB ‚Üí Play Store
        |
        ‚îî‚îÄ‚îÄ iOS Pipeline (macOS Runner)
               ‚îî‚îÄ‚îÄ Xcode + Fastlane ‚Üí TestFlight
</pre>
</div>

<h2>‚úÖ Step 1 ‚Äì Prerequisites</h2>

<h3>Android</h3>
<ul>
  <li>Google Play Console app</li>
  <li>Keystore (.jks)</li>
  <li>Play Store service account JSON</li>
</ul>

<h3>iOS</h3>
<ul>
  <li>Apple Developer account</li>
  <li>App Store Connect app</li>
  <li>macOS machine for runner</li>
</ul>

<h2>üîê Step 2 ‚Äì Repository Variables</h2>

<h3>Android</h3>
<table>
  <tr><th>Variable</th><th>Purpose</th></tr>
  <tr><td>ANDROID_KEYSTORE_BASE64</td><td>Secure keystore</td></tr>
  <tr><td>ANDROID_KEYSTORE_PASSWORD</td><td>Signing</td></tr>
  <tr><td>ANDROID_KEY_ALIAS</td><td>Signing</td></tr>
  <tr><td>ANDROID_KEY_PASSWORD</td><td>Signing</td></tr>
  <tr><td>GOOGLE_PLAY_JSON_KEY</td><td>Play Store API</td></tr>
  <tr><td>ANDROID_PACKAGE_NAME</td><td>Application ID</td></tr>
</table>

<h3>iOS</h3>
<table>
  <tr><th>Variable</th><th>Purpose</th></tr>
  <tr><td>APP_STORE_CONNECT_API_KEY_ID</td><td>API auth</td></tr>
  <tr><td>APP_STORE_CONNECT_ISSUER_ID</td><td>API auth</td></tr>
  <tr><td>APP_STORE_CONNECT_KEY_BASE64</td><td>API auth</td></tr>
  <tr><td>IOS_BUNDLE_ID</td><td>App ID</td></tr>
  <tr><td>APPLE_ID_EMAIL</td><td>Fastlane</td></tr>
  <tr><td>FASTLANE_TEAM_ID</td><td>Apple team</td></tr>
  <tr><td>MATCH_PASSWORD</td><td>Cert encryption</td></tr>
</table>

<h2>‚öôÔ∏è Step 3 ‚Äì Fastlane (iOS)</h2>

<div class="code-box">
<pre>
gem install fastlane
fastlane init
</pre>
</div>

<h3>Fastfile (Release Lane)</h3>

<div class="code-box">
<pre>
platform :ios do
  lane :release do
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_KEY_BASE64"],
      is_key_content_base64: true
    )

    match(type: "appstore", api_key: api_key, readonly: true)

    build_app(export_method: "app-store")

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end
end
</pre>
</div>

<h2>üì¶ Step 4 ‚Äì FINAL Combined Pipeline</h2>

<div class="code-box">
<pre>
image: node:18

pipelines:
  branches:
    master:

      - step:
          name: Android | Build & Deploy
          script:
            - npm install
            - echo $ANDROID_KEYSTORE_BASE64 | base64 -d > android/app/release.keystore
            - cd android && ./gradlew bundleRelease && cd ..
            - echo $GOOGLE_PLAY_JSON_KEY | base64 -d > playstore.json
            - pipe: atlassian/google-play-deploy:1.4.1
              variables:
                KEY_FILE: playstore.json
                PACKAGE_NAME: $ANDROID_PACKAGE_NAME
                BUNDLE: android/app/build/outputs/bundle/release/app-release.aab
                TRACK: production

      - step:
          name: iOS | TestFlight Upload
          runs-on:
            - self.hosted
            - macos
          script:
            - npm install
            - bundle install
            - cd ios && pod install && cd ..
            - bundle exec fastlane ios release
</pre>
</div>

<h2>üß† Why This Design Is Best</h2>

<ul>
  <li>‚úî Windows-friendly</li>
  <li>‚úî No secrets in repository</li>
  <li>‚úî Apple & Google recommended flow</li>
  <li>‚úî Fully automated</li>
  <li>‚úî Enterprise-grade security</li>
</ul>

<footer>
  ¬© Bitbucket CI/CD ‚Äì iOS + Android (Windows Developers)
</footer>

</body>
</html>
